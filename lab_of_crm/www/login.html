{% extends "templates/web.html" %}

{% set title = "" %}
{% set show_title = false %}

{% block title %}{% endblock %}
{% block breadcrumbs %}{% endblock %}
{% block page_header %}{% endblock %}
{% block header %}{% endblock %}
{% block main_section %}{% endblock %}
{% block footer %}{% endblock %}
{% block sidebar %}{% endblock %}
{% block navbar %}{% endblock %}

{% block head_include %}
  {{ include_style('login.bundle.css') }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block page_content %}
<div class="login-wrapper">
	<div class="login-form-section">

		<!-- Wrapper for switching forms -->
		<div id="form-container" style="width: 100%;">

			<!-- Login Form -->
			<form method="POST" action="/api/method/lab_of_crm.www.login.custom_login" id="login-form" class="visible">
				<div class="form-logo" style="padding: 50px; margin-top: -60px;">
					<img src="/images/labofcrm_login.png" alt="Logo" class="logo-img" style="width: 170px; height: auto;">
				  </div>				  

				<label for="login_email">{{ _('Email') }}</label>
				<input type="text" id="login_email" class="form-control custom-input" name="usr"
					placeholder="jane@example.com" required autofocus autocomplete="username">

				<label for="login_password">{{ _('Password') }}</label>
				<div class="password-wrapper">
					<input type="password" id="login_password" class="form-control custom-input" name="pwd"
					  placeholder="Enter your password" required autocomplete="current-password">
					<i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility()"></i> <!-- Eye Icon -->
				  </div>				  

				<!-- Forgot password link -->
				<p style="text-align: right;">
					<a href="#forgot" onclick="showForgotForm()" style="font-size: 12px; color: #a56cc8;">
					  {{ _('Forgot Password?') }}
					</a>
				  </p>				  

				<button class="btn btn-login custom-login-btn" type="submit">
					{{ _("Login Now") }}
				</button>

				{% if message %}
					<div class="alert alert-danger text-center">{{ message }}</div>
				{% endif %}

				<div class="login-divider-line">
					<span>{{ _("or with") }}</span>
				</div>

				<div class="social-login-buttons custom-social-buttons">
					<a href="#" class="btn btn-login-option btn-google-custom" onclick="triggerEmailField(event)">
						<img src="https://developers.google.com/identity/images/g-logo.png" 
							 alt="Google" width="18" height="18" style="margin-right: 8px; vertical-align: middle;"> Google
					</a>
					<a href="#" class="btn btn-login-option btn-facebook-custom" onclick="triggerEmailField(event)">
						<img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" 
							 alt="Facebook" width="18" height="18" style="margin-right: 8px; vertical-align: middle;"> Facebook
					</a>
				</div>
				
				<p style="margin-top: 1.5rem; font-size: 14px; text-align: center;">
					{{ _("Don't have an account yet?") }}
					<a href="/signup" style="text-decoration: underline; color: #a56cc8;">{{ _("Sign up") }}</a>
				</p>
			</form>

			<!-- Forgot Password UI Section -->
			<div id="forgot-password-form" class="hidden">
				<h4>{{ _('Reset Your Password') }}</h4>
				<p style="font-size: 14px;">{{ _('Enter your email and we’ll send you reset instructions.') }}</p>

				<!-- Message box -->
				<div id="reset-msg-box" style="margin-bottom: 1rem; display: none;"></div>

				<form id="reset-password-form">
					<input type="email" name="user" class="form-control custom-input" placeholder="{{ _('Email Address') }}" required>

					<button type="submit" class="btn btn-login custom-login-btn" style="margin-top: 1rem;">
						{{ _('Send Reset Link') }}
					</button>
					<p style="margin-top: 10px;">
						<a href="#" onclick="hideForgotForm()" style="font-size: 14px; color: #a56cc8;">{{ _('Back to Login') }}</a>
					</p>
				</form>
			</div>

		</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script>
	function showForgotForm() {
  document.getElementById('login-form').classList.remove('visible');
  document.getElementById('login-form').classList.add('hidden');

  document.getElementById('forgot-password-form').classList.remove('hidden');
  document.getElementById('forgot-password-form').classList.add('visible');
}

function hideForgotForm() {
  document.getElementById('forgot-password-form').classList.remove('visible');
  document.getElementById('forgot-password-form').classList.add('hidden');

  document.getElementById('login-form').classList.remove('hidden');
  document.getElementById('login-form').classList.add('visible');

  const msgBox = document.getElementById('reset-msg-box');
  msgBox.style.display = 'none';
  msgBox.innerHTML = '';
  msgBox.className = '';
}


	function triggerEmailField(event) {
		event.preventDefault();
		document.getElementById('login_email').focus();
	}

	document.addEventListener('DOMContentLoaded', function () {
		const resetForm = document.getElementById('reset-password-form');
		const msgBox = document.getElementById('reset-msg-box');

		resetForm.addEventListener('submit', async function (e) {
			e.preventDefault();

			msgBox.style.display = 'none';
			msgBox.innerHTML = '';
			msgBox.className = '';

			const email = this.user.value;

			try {
				const res = await fetch('/api/method/lab_of_crm.www.login.reset_password', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ user: email })
				});

				const data = await res.json();

				if (data.message && data.message.reset_link) {
					msgBox.style.display = 'block';
					msgBox.className = 'alert alert-success';
					msgBox.innerHTML = '✅ ' + '{{ _("Password reset link sent to your email.") }}';
				} else {
					throw new Error(data.message || 'Something went wrong');
				}
			} catch (err) {
				msgBox.style.display = 'block';
				msgBox.className = 'alert alert-danger';
				msgBox.innerHTML = '❌ ' + (err.message || '{{ _("An unexpected error occurred.") }}');
			}
		});
	});

	function togglePasswordVisibility() {
		var passwordField = document.getElementById('login_password');
		var icon = document.querySelector('.toggle-password');

		if (passwordField.type === "password") {
			passwordField.type = "text";  // Show the password
			icon.classList.remove('fa-eye');
			icon.classList.add('fa-eye-slash'); // Change to eye-slash icon
		} else {
			passwordField.type = "password"; // Hide the password
			icon.classList.remove('fa-eye-slash');
			icon.classList.add('fa-eye'); // Change back to eye icon
		}
}

</script>
<script>{% include "templates/includes/login/login.js" %}</script>
{% endblock %}
